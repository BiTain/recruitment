<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tổng quan doanh nghiệp</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .nav-link.active {
            background-color: #0d6efd;
        }

        .sidebar {
            min-height: calc(100vh - 56px);
        }

        .avatar-sm {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }

        .cover-img {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }

        .logo-container {
            margin-top: -75px;
        }

        .company-logo {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border: 5px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-edit {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .section-header {
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .info-label {
            font-weight: 500;
            color: #6c757d;
        }

        .info-content {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid #0d6efd;
        }

        .benefit-item {
            transition: all 0.2s;
        }

        .benefit-item:hover {
            background-color: #f8f9fa;
        }

        .contact-icon {
            width: 40px;
            height: 40px;
            background-color: #e7f1ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0d6efd;
            margin-right: 15px;
        }

        .modal-header {
            background-color: #f8f9fa;
        }

        .form-floating > label {
            color: #6c757d;
        }
    </style>
</head>
<body class="bg-light">

<div th:replace="business/header :: header"></div>

<div class="container-fluid">
    <div class="row">
        <div th:replace="business/sidebar :: sidebar"></div>

        <!-- Main Content -->
        <div class="col-lg-10 p-4">
            <!-- Cover and Logo Section -->
            <div class="card shadow mb-4 overflow-hidden position-relative">
                <div class="card-body pb-0">
                    <div class="row">
                        <div class="col-md-3 text-center position-relative mb-3">
                            <img th:src="@{'/files/' + ${doanhNghiep.anhDaiDien}}" class="company-logo rounded-circle"
                                 alt="Logo">
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-center h-100">
                                <div>
                                    <h1 class="mb-1" th:text="${doanhNghiep.tenDoanhNghiep}">Tên doanh nghiệp</h1>
                                </div>
                                <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                        data-bs-target="#editBasicInfoModal">
                                    <i class="bi bi-pencil"></i> Chỉnh sửa thông tin
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Info Cards -->
                <div class="card-body pt-0">
                    <div class="row mt-4">
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-center p-3 border rounded shadow-sm">
                                <div class="contact-icon">
                                    <i class="bi bi-building"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Mô Hình</div>
                                    <div class="fw-bold" th:text="${doanhNghiep.moHinh}"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-center p-3 border rounded shadow-sm">
                                <div class="contact-icon">
                                    <i class="bi bi-briefcase"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Lĩnh vực</div>
                                    <div class="fw-bold" th:text="${doanhNghiep.linhVuc}">www.company.com</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-center p-3 border rounded shadow-sm">
                                <div class="contact-icon">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Mã số thuế</div>
                                    <div class="fw-bold" th:text="${doanhNghiep.maSoThue}">www.company.com</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-center p-3 border rounded shadow-sm">
                                <div class="contact-icon">
                                    <i class="bi bi-envelope-fill"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Email</div>
                                    <div class="fw-bold" th:text="${doanhNghiep.taiKhoan.email}">contact@company.com
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-center p-3 border rounded shadow-sm">
                                <div class="contact-icon">
                                    <i class="bi bi-telephone-fill"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Điện thoại</div>
                                    <div class="fw-bold" th:text="${doanhNghiep.soDienThoai}">+84 123 456 789</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-center p-3 border rounded shadow-sm">
                                <div class="contact-icon">
                                    <i class="bi bi-globe"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Website</div>
                                    <div class="fw-bold" th:text="${doanhNghiep.trangDoanhNghiep}">www.company.com</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Company Information -->
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Thông tin khác</h5>
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                    data-bs-target="#editDetailInfoModal">
                                <i class="bi bi-pencil"></i> Chỉnh sửa
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-12">
                                    <div class="info-label">Địa chỉ</div>
                                    <div class="info-content mt-2" th:text="${doanhNghiep.diaChi}">Số 1, Đường ABC, Quận
                                        XYZ, TP. Hồ Chí Minh
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="section-header">
                                        <h5><i class="bi bi-file-text"></i> Mô tả doanh nghiệp</h5>
                                    </div>
                                    <div class="p-3 bg-white rounded border">
                                        <p th:text="${doanhNghiep.moTa}">Lorem ipsum dolor sit amet, consectetur
                                            adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna
                                            aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris
                                            nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in
                                            reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla
                                            pariatur.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Benefits and Contacts -->
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-award"></i> Phúc lợi</h5>
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                    data-bs-target="#editBenefitsModal">
                                <i class="bi bi-pencil"></i> Chỉnh sửa
                            </button>
                        </div>
                        <div class="card-body">
                            <ul class="list-group">
                                <li th:each="phucLoi : ${doanhNghiep.phucLoi.split(',')}"
                                    class="list-group-item benefit-item d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span th:text="${phucLoi.trim()}"></span>
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Logo -->
<div class="modal fade" id="editLogoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa logo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <img src="https://via.placeholder.com/150" class="rounded-circle" width="150" height="150">
                </div>
                <div class="mb-3">
                    <label for="logoFile" class="form-label">Chọn file ảnh mới</label>
                    <input class="form-control" type="file" id="logoFile">
                    <div class="form-text">Định dạng được hỗ trợ: JPG, PNG. Kích thước tối đa: 2MB</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal Edit Basic Info -->
<div class="modal fade" id="editBasicInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa thông tin cơ bản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form
                        enctype="multipart/form-data"
                        th:action="@{/doanh-nghiep/cap-nhap-co-ban/{maDoanhNghiep}(maDoanhNghiep=${doanhNghiep.maDoanhNghiep})}"
                      th:object="${doanhNghiep}" th:method="POST"
                      class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="companyName" placeholder="Tên doanh nghiệp"
                                   th:field="*{tenDoanhNghiep}">
                            <label for="companyName">Tên doanh nghiệp</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="companyType" placeholder="Mô hình doanh nghiệp"
                                   th:field="*{moHinh}">
                            <label for="companyType">Mô hình doanh nghiệp</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="email" class="form-control" id="companyEmail" placeholder="Email"
                                   th:field="*{taiKhoan.email}">
                            <input type="text" class="form-control" hidden
                                   th:field="*{taiKhoan.maTaiKhoan}">
                            <label for="companyEmail">Email</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="tel" class="form-control" id="companyPhone" placeholder="Điện thoại"
                                   th:field="*{soDienThoai}">
                            <label for="companyPhone">Điện thoại</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="taxId" placeholder="Mã số thuế"
                                   th:field="*{maSoThue}">
                            <label for="taxId">Mã số thuế</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="website" placeholder="Website"
                                   th:field="*{trangDoanhNghiep}">
                            <label for="website">Website</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="file" class="form-control" id="schoolLogo" th:field="*{logoFile}"
                                   onchange="previewImage(event)">
                            <label for="schoolLogo">Biểu tượng trường</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="linh-vuc" placeholder="Lĩnh vực"
                                   th:field="*{linhVuc}">
                            <label for="website">Lĩnh vực</label>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Detail Info -->
<div class="modal fade" id="editDetailInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa thông tin chi tiết</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST"
                      th:action="@{/doanh-nghiep/cap-nhap-chi-tiet/{maDoanhNghiep}(maDoanhNghiep=${doanhNghiep.maDoanhNghiep})}"
                      th:object="${doanhNghiep}"
                      class="row g-3">
                    <!-- Quận/Huyện -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <select class="form-select" id="districtSelect" th:field="*{huyen}">
                                <option value="" selected disabled>Chọn quận/huyện</option>
                            </select>
                            <label for="districtSelect">Quận/Huyện</label>
                        </div>
                    </div>

                    <!-- Phường/Xã -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <select class="form-select" id="wardSelect" th:field="*{xa}">
                                <option value="" selected disabled>Chọn phường/xã</option>
                            </select>
                            <label for="wardSelect">Phường/Xã</label>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="address" placeholder="Địa chỉ"
                                   th:field="*{chiTietDiaChi}">
                            <label for="address">Địa chỉ</label>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <label for="description" class="form-label">Mô tả doanh nghiệp</label>
                        <textarea class="form-control" id="description" th:field="*{moTa}" rows="5">
                        </textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Benefits -->
<div class="modal fade" id="editBenefitsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa phúc lợi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="benefitsList">
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="Bảo hiểm theo quy định">
                        <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="Đào tạo nội bộ">
                        <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="Du lịch hàng năm">
                        <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="Thưởng hiệu suất">
                        <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="Chế độ nghỉ phép linh hoạt">
                        <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <button class="btn btn-outline-primary w-100 mt-3" id="addBenefitBtn">
                    <i class="bi bi-plus-circle"></i> Thêm phúc lợi
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveBenefitsBtn">Lưu thay đổi</button>
                <form id="benefitsForm" method="POST"
                      th:action="@{/doanh-nghiep/cap-nhap-phuc-loi/{maDoanhNghiep}(maDoanhNghiep=${doanhNghiep.maDoanhNghiep})}">
                    <input type="hidden" th:name="phuc-loi" id="benefitsInput">
                </form>
            </div>
        </div>
    </div>
</div>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div th:if="${successMsg}" class="toast text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="5000">
        <div class="toast-header">
            <strong class="me-auto">Thông báo</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" th:text="${successMsg}"></div>
    </div>
    <div th:if="${errorMsg}" class="toast text-white bg-danger" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="5000">
        <div class="toast-header">
            <strong class="me-auto">Lỗi</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" th:text="${errorMsg}"></div>
    </div>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var toastElList = document.querySelectorAll('.toast');
        toastElList.forEach(function(toastEl) {
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        });
    });
</script>

<script>
    // Thêm phúc lợi mới
    document.getElementById('addBenefitBtn').addEventListener('click', function () {
        const benefitsList = document.getElementById('benefitsList');
        const newItem = document.createElement('div');
        newItem.className = 'input-group mb-2';
        newItem.innerHTML = `
            <input type="text" class="form-control" placeholder="Nhập phúc lợi mới">
            <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
        `;
        benefitsList.appendChild(newItem);

        // Gắn sự kiện xóa
        newItem.querySelector('button').addEventListener('click', function () {
            benefitsList.removeChild(newItem);
        });

        // Focus vào input mới
        newItem.querySelector('input').focus();
    });

    // Gắn sự kiện xóa cho các nút xóa có sẵn
    document.querySelectorAll('#benefitsList .btn-outline-danger').forEach(button => {
        button.addEventListener('click', function () {
            this.closest('.input-group').remove();
        });
    });

    const benefitsFromDB = '[[${doanhNghiep.phucLoi}]]';
    const benefitsArray = benefitsFromDB.split(', ').filter(b => b.trim() !== '');

    const benefitsList = document.getElementById('benefitsList');
    benefitsList.innerHTML = ''; // Xóa mẫu cứng

    benefitsArray.forEach(benefit => {
        const item = document.createElement('div');
        item.className = 'input-group mb-2';
        item.innerHTML = `
            <input type="text" class="form-control" value="${benefit}">
            <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
        `;
        benefitsList.appendChild(item);

        item.querySelector('button').addEventListener('click', function () {
            benefitsList.removeChild(item);
        });
    });
</script>

<script>
    document.getElementById('saveBenefitsBtn').addEventListener('click', function () {
        const inputs = document.querySelectorAll('#benefitsList input');
        const benefits = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(val => val !== '')
            .join(', ');

        document.getElementById('benefitsInput').value = benefits;

        // Gửi form
        document.getElementById('benefitsForm').submit();
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        function normalize(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }


        const districtSelect = document.getElementById("districtSelect");
        const wardSelect = document.getElementById("wardSelect");

        const defaultDistrict = '[[${doanhNghiep.huyen}]]'
        const defaultWard = '[[${doanhNghiep.xa}]]'


        // Lấy quận/huyện của Đà Nẵng
        fetch("https://provinces.open-api.vn/api/p/48?depth=2")
            .then(res => res.json())
            .then(data => {
                const districts = data.districts;
                districts.forEach(d => {
                    const option = document.createElement("option");
                    option.value = d.name;
                    option.textContent = d.name;
                    if (d.name === defaultDistrict) option.selected = true;
                    districtSelect.appendChild(option);
                });

                // Nếu có quận mặc định, gọi change để load phường
                if (defaultDistrict) {
                    districtSelect.dispatchEvent(new Event('change'));
                }
            });

        // Khi chọn quận/huyện, load phường/xã tương ứng
        districtSelect.addEventListener("change", function () {
            const selectedDistrictName = this.value;
            wardSelect.innerHTML = '<option value="" disabled selected>Chọn phường/xã</option>';

            // Lấy lại danh sách quận/huyện để lấy code của quận
            fetch("https://provinces.open-api.vn/api/p/48?depth=2")
                .then(res => res.json())
                .then(data => {
                    const district = data.districts.find(d => d.name === selectedDistrictName);
                    if (!district) return;

                    // Lấy danh sách phường theo quận
                    fetch(`https://provinces.open-api.vn/api/d/${district.code}?depth=2`)
                        .then(res => res.json())
                        .then(data => {
                            const wards = data.wards;
                            wards.forEach(w => {
                                const option = document.createElement("option");
                                option.value = w.name;
                                option.textContent = w.name;
                                if (normalize(w.name) === normalize(defaultWard)) {
                                    option.selected = true;
                                }
                                wardSelect.appendChild(option);
                            });
                        });
                });
        });
    });
</script>

</body>
</html>